{
  "size": 10,
  "from": {{multiply (subtract (default request.params.query.page 1) 1) 10}},
  "_source": [
    "Id",
    "slug",
    "vacancy_status",
    "rendered.vacancy_status",
    "top_job",
    "description_short",
    "title",
    "geo_vacancy_coords",
    "location",
    "salary",
    "role_status_list",
    "closing_date",
    "organisation.slug",
    "organisation.name",
    "organisation.has_logo",
    "organisation.logo_url",
    "rendered.goodmoves_rss"
  ],
  "query": {
    "bool": {
      {{#ifAny request.params.query.type request.params.query.sectors request.params.query.roles request.params.query.statuses request.params.query.lat ~}}
      "filter": [
        {{#if request.params.query.type ~}}
        {{#compare request.params.query.type "===" "home-based" ~}}
        {
          "terms": {
            "remote_working": true
          }
        }
        {{#ifAny request.params.query.sectors request.params.query.roles request.params.query.statuses request.params.query.lat}},{{/ifAny}}
        {{/compare ~}}
        {{/if ~}}
        {{#if request.params.query.sectors ~}}
        {
          "terms": {
            "sectors_slugs": {{{stringify (arrayify request.params.query.sectors)}}}
          }
        }
        {{#ifAny request.params.query.roles request.params.query.statuses request.params.query.lat}},{{/ifAny}}
        {{/if ~}}
        {{#if request.params.query.roles ~}}
        {
          "terms": {
            "roles_slugs": {{{stringify (arrayify request.params.query.roles)}}}
          }
        }
        {{#ifAny request.params.query.statuses request.params.query.lat}},{{/ifAny}}
        {{/if ~}}
        {{#if request.params.query.statuses ~}}
        {
          "terms": {
            "role_status_slug": {{{stringify (arrayify request.params.query.statuses)}}}
          }
        }
        {{#ifAny request.params.query.lat}},{{/ifAny}}
        {{/if}}
        {{#if request.params.query.lat ~}}
        {
          "geo_distance": {
            "distance": "{{default request.params.query.distance "8046.72"}}meters",
            "geo_vacancy_coords": {
              "lat": {{request.params.query.lat}},
              "lon": {{request.params.query.lng}}
            }
          }
        }
        {{/if ~}}
      ],
      {{/ifAny ~}}
      "must": [
        {{#if request.params.query.keywords ~}}
        {
          "query_string": {
            "query": {{{stringify request.params.query.keywords}}},
            "fields": ["text_bag_boost^5", "text_bag"],
            "default_operator": "AND",
            "analyzer": "snowball"
          }
        },
        {{/if ~}}
        {{#if request.params.query.salary_min ~}}
        {
          "range": {
            "salary_min": {
              "gte": {{replace (trim request.params.query.salary_min) "," ""}}
            }
          }
        },
        {{/if ~}}
        {{#if request.params.query.salary_max ~}}
        {
          "range": {
            "salary_min": {
              "lte": {{replace (trim request.params.query.salary_max) "," ""}}
            }
          }
        },
        {{/if ~}}
        {
          "term": {
            "country_iso3": "GBR"
          }
        },
        {
          "term": {
            "vacancy_status": "vacancy-open"
          }
        }
      ]
    }
  },
  "sort": [
    {{#if request.params.query.sort ~}}
    {{#compare request.params.query.sort "===" "salary_low" ~}}
    {
      "salary_min": "asc"
    },
    {
      "salary_max": "asc"
    }
    {{else}}
    {{#compare request.params.query.sort "===" "salary_high" ~}}
    {
      "salary_min": "desc"
    },
    {
      "salary_max": "desc"
    }
    {{else}}
    {{#compare request.params.query.sort "===" "newest" ~}}
    {
      "start_at": "desc"
    }
    {{else}}
    {{#compare request.params.query.sort "===" "oldest" ~}}
    {
      "start_at": "asc"
    }
    {{else}}
    {{#compare request.params.query.sort "===" "closing_soon" ~}}
    {
      "closing_date": "asc"
    }
    {{else}}
    {{#compare request.params.query.sort "===" "distance" ~}}
    {{#if request.params.query.lat ~}}
    {
      "_geo_distance" : {
        "geo_vacancy_coords" : [{{request.params.query.lat}}, {{request.params.query.lng}}],
        "order" : "asc",
        "unit" : "m",
        "mode" : "min",
        "distance_type" : "arc"
      }
    }
    {{else}}
    "_score"
    {{/if ~}}
    {{/compare ~}}
    {{/compare ~}}
    {{/compare ~}}
    {{/compare ~}}
    {{/compare ~}}
    {{/compare ~}}
    {{else}}
    "_score",
    {
      "start_at": "desc"
    }
    {{/if ~}}
  ]
}