{
  "size": 10,
  "from": {{multiply (subtract (default request.params.query.page 1) 1) 10}},
  "_source": [
    "Id",
    "slug",
    "fund_status",
    "rendered.fund_status",
    "top_job",
    "description_short",
    "title",
    "geo_fund_coords",
    "location",
    "salary",
    "role_status_list",
    "closing_date",
    "funder_organisation.slug",
    "funder_organisation.name",
    "funder_organisation.has_logo",
    "funder_organisation.logo_url",
    "rendered.goodmoves_rss"
  ],
  "query": {
    "bool": {
      {{#ifAny request.params.query.activities request.params.query.beneficiaries ~}}
      "filter": [
        {{#if request.params.query.activities ~}}
        {
          "terms": {
            "activities_slugs": {{{stringify (arrayify request.params.query.activities)}}}
          }
        }
        {{#ifAny request.params.query.beneficiaries}},{{/ifAny}}
        {{/if ~}}
        {{#if request.params.query.beneficiaries ~}}
        {
          "terms": {
            "beneficiaries_slugs": {{{stringify (arrayify request.params.query.beneficiaries)}}}
          }
        }
        {{/if ~}}
      ],
      {{/ifAny ~}}
      "must": [
        {{#if request.params.query.keywords ~}}
        {
          "query_string": {
            "query": {{{stringify request.params.query.keywords}}},
            "default_field": "text_bag",
            "default_operator": "AND",
            "analyzer": "snowball"
          }
        },
        {{/if ~}}
        {
          "term": {
            "fund_status": "Open"
          }
        }
      ]
    }
  },
  "sort": {
    "date_last_modified": "desc"
  }
}
