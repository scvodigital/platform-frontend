{
  {{#compare request.params.context "map"}}
  "size": 1000,
  "_source": ["Id", "title", "organisation.name", "geo_vacancy_coords", "closing_date", "remuneration_type", "salary", "status"],
  {{else}}
  "size": 10,
  "from": {{multiply (subtract (default request.params.query.query.page 1) 1) 10}},
  "_source": {
    "includes": [ "*" ],
    "excludes": [ "text_bag", "text_bag_boost" ]
  },
  {{/compare}}
  "query": {
    "bool": {
      {{#ifAny request.params.query.sectors request.params.query.roles request.params.query.statuses request.params.query.distance}}
      "filter": [
        {{#if request.params.query.sectors}}
        {
          "terms": {
            "sectors": {{{stringify (arrayify request.params.query.sectors)}}}
          }
        }
        {{#ifAny request.params.query.roles request.params.query.statuses request.params.query.distance}},{{/ifAny}}
        {{/if}}
        {{#if request.params.query.roles}}
        {
          "terms": {
            "roles": {{{stringify (arrayify request.params.query.roles)}}}
          }
        }
        {{#ifAny request.params.query.statuses request.params.query.distance}},{{/ifAny}}
        {{/if}}
        {{#if request.params.query.statuses}}
        {
          "terms": {
            "status": {{{stringify (arrayify request.params.query.statuses)}}}
          }
        }
        {{#ifAny request.params.query.distance}},{{/ifAny}}
        {{/if}}
        {{#if request.params.query.distance}}
        {
          "geo_distance": {
            "distance": "{{default request.params.query.distance "8046.72"}}meters",
            "geo_vacancy_coords": {
              "lat": {{request.params.query.lat}},
              "lon": {{request.params.query.lng}}
            }
          }
        }
        {{/if}}
      ],
      {{/ifAny}}
      "must": [
        {{#if request.params.query.keywords}}
        {
          "query_string": {
            "query": {{{stringify (join request.params.query.keywords " AND ")}}},
            "default_field": "text_bag",
            "default_operator": "AND",
            "analyzer": "snowball"
          }
        },
        {{/if}}
        {
          "term": {
            "vacancy_status": "vacancy-open"
          }
        }
      ]
    }
  }
}
